<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
  crossorigin="anonymous"
></script>

<script>
  function insertarContacto() {
    // Obtengo los datos del formulario
    let nombre = document.getElementById("nombre").value;
    let apellido = document.getElementById("apellido").value;
    let correo = document.getElementById("correo").value;
    let telefono = document.getElementById("telefono").value;

    // Cerrar el modal
    bootstrap.Modal.getInstance(
      document.getElementById("modalContacto")
    ).hide();

    // Eliminar la tabla
    eliminarTabla();

    // Creo el loader de carga
    crearLoaderRing("divContactos");

    // Obtengo los contactos, si es ok, creo la tabla, sino, devuelvo error
    google.script.run
      .withSuccessHandler(contactoInsertadoOK)
      .withFailureHandler(contactoInsertadoError)
      .insertarContacto(nombre, apellido, correo, telefono);
  }

  function contactoInsertadoOK() {
    // Limpio datos del formulario
    document.getElementById("nombre").value = "";
    document.getElementById("correo").value = "";
    // Elimino la tabla
    eliminarTabla();
    // Muestro el mensaje
    crearNotificacionOK("Contactos insertado correctamente", "OK");
    //Muestro la tabla
    crearTablaContactos();
    // Elimino el loader
    eliminarLoader();
  }

  function contactoInsertadoError() {
    // Mostrar notificacion de error
    crearNotificacionError("No se pudo insertar el contactos", "ERROR");
    //Muestro la tabla
    crearTablaContactos();
    // Elimino el loader
    eliminarLoader();
  }

  function crearTablaContactos() {
    // Borro la tabla si existe
    eliminarTabla();
    // Creo el loader de carga
    crearLoaderRing("divContactos");
    // Obtengo los contactos, si es ok, creo la tabla, sino, devuelvo error
    google.script.run
      .withSuccessHandler(crearTablaContactosOK)
      .withFailureHandler(crearTablaContactosError)
      .obtenerContactos();
  }

  function crearTablaContactosOK(obj) {
    // Creo la tabla y el body
    tabla = document.createElement("table");
    tabla.id = "tablaContactos";

    let tablaHeader = document.createElement("thead");
    let tablaBody = document.createElement("tbody");

    // Header de la tabla
    let fila = document.createElement("tr");
    for (let i = 0; i < obj[0].length; i++) {
      let celda = document.createElement("td");
      celda.textContent = obj[0][i];
      fila.appendChild(celda);
    }
    // Agrego la columna opciones
    celdaOpciones = document.createElement("td");
    celdaOpciones.textContent = "OPCIONES";
    celdaOpciones.classList.add("text-center");
    fila.appendChild(celdaOpciones);
    // Agrego la fila al header y el header a la tabla
    tablaHeader.appendChild(fila);
    tabla.appendChild(tablaHeader);

    // Body de la tabla
    for (let i = 1; i < obj.length; i++) {
      let fila = document.createElement("tr");
      for (let j = 0; j < obj[i].length; j++) {
        let celda = document.createElement("td");
        celda.textContent = obj[i][j];
        fila.appendChild(celda);
      }
      // Agrego los botones de opciones
      fila.appendChild(crearBotonesOpciones(i + 1, obj[i]));
      tablaBody.appendChild(fila);
    }
    // Agrego clases al header
    tablaHeader.classList.add("table-dark", "fw-bold");
    // Agrego el body a la tabla
    tabla.appendChild(tablaBody);
    // Agrego clases a la tabla
    tabla.classList.add(
      "table",
      "table-hover",
      "table-striped",
      "border",
      "border-4",
      "border-dark"
    );
    // Agrego la tabla a la pagina
    document.getElementById("divContactos").appendChild(tabla);

    // Mostrar notificacion de OK
    crearNotificacionOK("Contactos obtenidos correctamente", "OK");
    // Elimino el loader
    eliminarLoader();
  }

  function crearBotonesOpciones(nFila, datosContacto) {
    let celda = document.createElement("td");
    celda.classList.add("text-center");
    // Creo el boton de borrar
    let btnBorrar = document.createElement("button");
    btnBorrar.onclick = () => borrarContacto(nFila);
    btnBorrar.classList.add("btn", "btn-danger", "m-1", "btn-sm");
    let iconoBorrar = document.createElement("i");
    iconoBorrar.classList.add("bi", "bi-trash");
    btnBorrar.appendChild(iconoBorrar);
    // Creo el boton modificar
    let btnModificar = document.createElement("button");
    btnModificar.onclick = () =>
      abrirModalModificarContacto(nFila, datosContacto);
    btnModificar.classList.add("btn", "btn-warning", "m-1", "btn-sm");
    let iconoModificar = document.createElement("i");
    iconoModificar.classList.add("bi", "bi-pencil-square");
    btnModificar.appendChild(iconoModificar);
    // Agrego los botones a la celda
    celda.appendChild(btnBorrar);
    celda.appendChild(btnModificar);
    return celda;
  }

  function abrirModalNuevoContacto() {
    // Busco el boton submit del formulario en el modal
    let btnNuevoContacto = document.getElementById("btnCrearModificar");
    // Le cambio el texto
    btnNuevoContacto.textContent = "Guardar";
    btnNuevoContacto.classList = "";
    btnNuevoContacto.classList.add("btn", "btn-success");
    // Cambio el título del modal
    document.getElementById("tituloModal").textContent = "Nuevo Contacto";
    // Modifico el submit cambiando la funcion a ejectar
    document.getElementById("frmContacto").onsubmit = () => insertarContacto();
    // Cargo los datos en los inputs del formulario
    document.getElementById("nombre").value = "";
    document.getElementById("apellido").value = "";
    document.getElementById("correo").value = "";
    document.getElementById("telefono").value = "";
    // Abro el modal
    bootstrap.Modal.getOrCreateInstance(
      document.getElementById("modalContacto")
    ).show();
  }

  function abrirModalModificarContacto(nFila, datosContacto) {
    // Busco el boton submit del formulario en el modal
    let btnModificar = document.getElementById("btnCrearModificar");
    // Le cambio el texto
    btnModificar.textContent = "Modificar";
    btnModificar.classList = "";
    btnModificar.classList.add("btn", "btn-warning");
    // Cambio el título del modal
    document.getElementById("tituloModal").textContent = "Modificar Contacto";
    // Modifico el submit cambiando la funcion a ejectar
    document.getElementById("frmContacto").onsubmit = () =>
      modificarContacto(nFila);
    // Cargo los datos en los inputs del formulario
    document.getElementById("nombre").value = datosContacto[0];
    document.getElementById("apellido").value = datosContacto[1];
    document.getElementById("correo").value = datosContacto[2];
    document.getElementById("telefono").value = datosContacto[3];
    // Abro el modal
    bootstrap.Modal.getOrCreateInstance(
      document.getElementById("modalContacto")
    ).show();
  }

  function modificarContacto(nFila) {
    // Cierro el modal
    bootstrap.Modal.getOrCreateInstance(
      document.getElementById("modalContacto")
    ).hide();
    // Obtengo los datos del formulario
    let nombre = document.getElementById("nombre").value;
    let apellido = document.getElementById("apellido").value;
    let correo = document.getElementById("correo").value;
    let telefono = document.getElementById("telefono").value;
    // Eliminar la tabla
    eliminarTabla();
    // Creo el loader de carga
    crearLoaderRing("divContactos");

    // Modifico el contacto, si es ok, creo la tabla, sino, devuelvo error
    google.script.run
      .withSuccessHandler(contactoModificadoOk)
      .withFailureHandler(contactoModificadoError)
      .modificarContacto(nFila, { nombre, apellido, correo, telefono });
  }

  function contactoModificadoOk() {
    eliminarTabla();
    // Mostrar notificacion
    crearNotificacionOK("Contacto modificado correctamente", "OK");
    // Elimino el loader
    eliminarLoader();
    crearTablaContactos();
  }

  function contactoModificadoError() {
    eliminarTabla();
    // Mostrar notificacion de error
    crearNotificacionError("No se pudo modificar el contacto", "ERROR");
    // Elimino el loader
    eliminarLoader();
    crearTablaContactos();
  }

  function borrarContacto(nFila) {
    // Eliminar la tabla
    eliminarTabla();
    // Creo el loader de carga
    crearLoaderRing("divContactos");

    // Borro el contacto, si es ok, creo la tabla, sino, devuelvo error
    google.script.run
      .withSuccessHandler(contactoBorradoOk)
      .withFailureHandler(contactoBorradoError)
      .eliminarContacto(nFila);
  }

  function contactoBorradoOk() {
    eliminarTabla();
    // Mostrar notificacion
    crearNotificacionOK("Contacto eliminado correctamente", "OK");
    // Elimino el loader
    eliminarLoader();
    crearTablaContactos();
  }

  function contactoBorradoError() {
    eliminarTabla();
    // Mostrar notificacion de error
    crearNotificacionError("No se pudo borrar el contacto", "ERROR");
    // Elimino el loader
    eliminarLoader();
    crearTablaContactos();
  }

  function crearTablaContactosError() {
    // Mostrar notificacion de error
    crearNotificacionError("No se pudieron obtener los contactos", "ERROR");
    // Elimino el loader
    eliminarLoader();
  }

  function eliminarTabla() {
    let tabla = document.getElementById("tablaContactos");
    if (tabla) tabla.remove();
  }

  function crearNotificacion(mensaje, titulo) {
    document.getElementById("mensajeNotificacion").textContent = mensaje;
    document.getElementById("tituloNotificacion").textContent = titulo;
    let elementoNotificacion = document.getElementById("notificacion");
    bootstrap.Toast.getOrCreateInstance(elementoNotificacion).show();
  }

  function crearNotificacionOK(mensaje, titulo) {
    crearNotificacion(mensaje, titulo);
    crearIconoNotificacionOK();
    crearColorNotificacion("--color-verde-oscuro");
  }

  function crearNotificacionAdvertencia(mensaje, titulo) {
    crearNotificacion(mensaje, titulo);
    crearIconoNotificacionAdvertencia();
    crearColorNotificacion("--color-amarillo-oscuro");
  }

  function crearNotificacionError(mensaje, titulo) {
    crearNotificacion(mensaje, titulo);
    crearIconoNotificacionError();
    crearColorNotificacion("--color-rojo-oscuro");
  }

  function crearIconoNotificacionOK() {
    document.getElementById("iconoNotificacion").className = "";
    document
      .getElementById("iconoNotificacion")
      .classList.add("bi", "bi-check2-square");
  }
  function crearIconoNotificacionAdvertencia() {
    document.getElementById("iconoNotificacion").className = "";
    document.getElementById("iconoNotificacion").classList.add("bi", "bi-bug");
  }
  function crearIconoNotificacionError() {
    document.getElementById("iconoNotificacion").className = "";
    document
      .getElementById("iconoNotificacion")
      .classList.add("bi", "bi-exclamation-square");
  }

  function crearColorNotificacion(color) {
    let elementoNotificacion = document.getElementById("notificacion");
    elementoNotificacion.style.backgroundColor = getComputedStyle(
      document.documentElement
    ).getPropertyValue(color);
  }

  function crearLoader(elementoPadre) {
    eliminarLoader();
    //Creo el elemento
    let loader = document.createElement("div");
    loader.id = "loader";

    loader.appendChild(document.createElement("div"));
    loader.appendChild(document.createElement("div"));
    loader.appendChild(document.createElement("div"));
    loader.appendChild(document.createElement("div"));
    return document.getElementById(elementoPadre).appendChild(loader);
  }

  function crearLoaderRing(elementoPadre) {
    let loader = crearLoader(elementoPadre);
    loader.classList.add("lds-ring");
  }

  function crearLoaderEllipsis(elementoPadre) {
    let loader = crearLoader(elementoPadre);
    loader.classList.add("lds-ellipsis");
  }

  function eliminarLoader() {
    let loader = document.getElementById("loader");
    if (loader) loader.remove();
  }
</script>
