<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>

<script>
  function insertarContacto() {
    console.clear();
    // Obtengo los datos del formulario
    let nombre = document.getElementById("nombre").value;
    let correo = document.getElementById("correo").value;

    // Cerrar el modal
    bootstrap.Modal.getInstance(document.getElementById("crearContactoModal")).hide();
    
    // Eliminar la tabla
    eliminarTabla();
    
    // Creo el loader de carga
    crearLoaderRing("divContactos")
    
    // Obtengo los contactos, si es ok, creo la tabla, sino, devuelvo error
    google.script.run
      .withSuccessHandler(contactoInsertadoOK)
      .withFailureHandler(contactoInsertadoError)
      .insertarContacto(nombre,correo);
  }

  function contactoInsertadoOK(){
    // Limpio datos del formulario
    document.getElementById("nombre").value = "";
    document.getElementById("correo").value = "";
    // Elimino la tabla
    eliminarTabla();
    // Muestro el mensaje
    crearNotificacionOK("Contactos insertado correctamente", "OK");
    //Muestro la tabla
    crearTablaContactos();
    // Elimino el loader
    eliminarLoader();
  }

  function contactoInsertadoError(){
    // Mostrar notificacion de error
    crearNotificacionError("No se pudo insertar el contactos", "ERROR");
    //Muestro la tabla
    crearTablaContactos();
    // Elimino el loader
    eliminarLoader(); 
  }

  function crearTablaContactos() {
    console.clear();
    // Borro la tabla si existe
    eliminarTabla();
    // Creo el loader de carga
    crearLoaderRing("divContactos")
    // Obtengo los contactos, si es ok, creo la tabla, sino, devuelvo error
    google.script.run
      .withSuccessHandler(crearTablaContactosOK)
      .withFailureHandler(crearTablaContactosError)
      .obtenerContactos();
  }

  function crearTablaContactosOK(obj) {
    // Creo la tabla y el body
    tabla = document.createElement("table");
    tabla.id = "tablaContactos";

    let tablaHeader = document.createElement("thead");
    let tablaBody = document.createElement("tbody");
    Array.from(obj).forEach((filaActual, i) => {
      // Creo la fila
      let fila = document.createElement("tr");
      //incerto las columnas
      filaActual.forEach((columnaActual) => {
        //creo la columna
        columna = document.createElement("td");
        columna.textContent = columnaActual;
        fila.appendChild(columna);
      });
      if (i == 0) {
        tablaHeader.appendChild(fila);
        tabla.appendChild(tablaHeader);
      } else {
        tablaBody.appendChild(fila);
      }
    });
    tablaHeader.classList.add("table-dark", "fw-bold");
    tabla.appendChild(tablaBody);
    tabla.classList.add(
      "table",
      "table-hover",
      "table-striped",
      "border",
      "border-4",
      "border-dark"
    );
    document.getElementById("divContactos").appendChild(tabla);

    // Mostrar notificacion de OK
    crearNotificacionOK("Contactos obtenidos correctamente", "OK");
    // Elimino el loader
    eliminarLoader();
  }

  function crearTablaContactosError() {
    // Mostrar notificacion de error
    crearNotificacionError("No se pudieron obtener los contactos", "ERROR");
    // Elimino el loader
    eliminarLoader();
  }

  function eliminarTabla(){
    let tabla = document.getElementById("tablaContactos");
    if (tabla) tabla.remove();
  }

  function crearNotificacion(mensaje,titulo){
    document.getElementById('mensajeNotificacion').textContent = mensaje;
   document.getElementById('tituloNotificacion').textContent = titulo;
   let elementoNotificacion = document.getElementById('notificacion');
   bootstrap.Toast.getOrCreateInstance(elementoNotificacion).show();
  }

  function crearNotificacionOK(mensaje,titulo){
    crearNotificacion(mensaje,titulo);
    crearIconoNotificacionOK();
    crearColorNotificacion('--color-verde-oscuro');
  }
  
  function crearNotificacionAdvertencia(mensaje,titulo){
crearNotificacion(mensaje,titulo);
    crearIconoNotificacionAdvertencia();
    crearColorNotificacion('--color-amarillo-oscuro');
  }
  
  function crearNotificacionError(mensaje,titulo){
crearNotificacion(mensaje,titulo);
    crearIconoNotificacionError();
    crearColorNotificacion('--color-rojo-oscuro');
  }

  function crearIconoNotificacionOK(){
    document.getElementById('iconoNotificacion').className = '';
    document.getElementById('iconoNotificacion').classList.add('bi','bi-check2-square');
  }
  function crearIconoNotificacionAdvertencia(){
    document.getElementById('iconoNotificacion').className = '';
    document.getElementById('iconoNotificacion').classList.add('bi','bi-bug');
  }
  function crearIconoNotificacionError(){
    document.getElementById('iconoNotificacion').className = '';
    document.getElementById('iconoNotificacion').classList.add('bi','bi-exclamation-square');
  }

  function crearColorNotificacion(color){
    let elementoNotificacion = document.getElementById('notificacion');
    elementoNotificacion.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue(color);
  }

  function crearLoader(elementoPadre){
    eliminarLoader();
    //Creo el elemento
    let loader = document.createElement("div");
    loader.id = "loader";
    
    loader.appendChild(document.createElement("div"));
    loader.appendChild(document.createElement("div"));
    loader.appendChild(document.createElement("div"));
    loader.appendChild(document.createElement("div"));
    return document.getElementById(elementoPadre).appendChild(loader);
  }

  function crearLoaderRing(elementoPadre){
    let loader = crearLoader(elementoPadre);
    loader.classList.add("lds-ring");
  }

  function crearLoaderEllipsis(elementoPadre){
    let loader = crearLoader(elementoPadre);
    loader.classList.add("lds-ellipsis");
  }

  function eliminarLoader(){
    let loader = document.getElementById("loader");
    if(loader) loader.remove();
  }
</script>